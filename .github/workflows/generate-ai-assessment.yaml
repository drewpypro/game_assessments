name: Generate AI Assessment Workflow

on:
  issues:
    types: [opened, edited]  # Issue form submission
  pull_request_review:
    types: [submitted]       # PR approved
  pull_request:
    types: [closed]          # Merged (for docs sync, if you want)


jobs:
  validate:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      game_name: ${{ steps.pre_process_validation.outputs.game_name }}
      validation_result: ${{ steps.request_validation.outputs.result }}
      validation_message: ${{ steps.request_validation.outputs.message }}
      slug: ${{ steps.request_validation.outputs.slug }}
      json_path: ${{ steps.request_validation.outputs.json_path }}
      md_path: ${{ steps.request_validation.outputs.md_path }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Pre Processing
        id: pre_process_validation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Extracting game name"
          jq -r '.issue.body' "$GITHUB_EVENT_PATH" > /tmp/game_name.txt
          echo "DEBUG: validate game_name"
          cat /tmp/game_name.txt
          echo "DEBUG: Load github output"
          echo "game_name=$(cat /tmp/game_name.txt)" >> $GITHUB_OUTPUT
          echo "DEBUG: Test github outputs"
          echo $GITHUB_OUTPUT

      - name: Validate Request
        uses: drewpypro/drewpy-actions/request_validation@gamesv1
        id: request_validation
        with:
          game_name: ${{ needs.validate.outputs.game_name }}

      - name: Generate Approval PR
        id: pre_approval
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: github-actions@github.com
          GIT_COMMITTER_NAME: github-actions
          GIT_COMMITTER_EMAIL: github-actions@github.com
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Generating PR for approval if necessary"
          AUTHOR=$(jq -r '.issue.user.login' "$GITHUB_EVENT_PATH")
          ISSUE_ID=${{ github.event.issue.number }}
          BRANCH="issue-${ISSUE_ID}"          

          if [ "$AUTHOR" = "drewpypro" ]; then
            echo "âœ… Auto-approving" > /tmp/issue_comment.txt
            gh label create "drewpypro" --color DAE8FC --description "ðŸ†"
            gh issue edit "$ISSUE_ID" --add-label "drewpypro"          
          else

            # Check if branch already exists
            if git ls-remote --heads origin | grep -q "refs/heads/$BRANCH"; then
              # Branch exists, create a unique branch name
              BRANCH="issue-${ISSUE_ID}-$(date +%s)"
            fi

            # Create and switch to the branch
            git checkout -b "$BRANCH"

            # Commit only if there are changes
            if ! git diff --staged --quiet; then
              git commit -m "Add ${GAME_NAME} from issue #${ISSUE_ID}"
              
              # Force push or push with lease to handle potential conflicts
              git push -f origin "$BRANCH"

              PR_URL=$(gh pr create \
                --title "[Auto] Review game assessment request submitted through #${ISSUE_ID}" \
                --body "This PR generates a request to review #${ISSUE_ID} for ${GAME_NAME} by ${AUTHOR}." \
                --head "$BRANCH" \
                --base main)

            echo "A PR has been submitted for review, please wait for approval" > /tmp/issue_comment.txt
            gh issue comment $ISSUE_ID --body-file /tmp/issue_comment.txt
            gh label create "pending-approval" --color FBCA04 --description "awaiting approval" || true
            gh issue edit "$ISSUE_ID" --add-label "pending-approval"

  generate_assessment:
    if: github.event_name == 'pull_request_review' &&
        github.event.review.state == 'approved' &&
        contains(github.event.pull_request.labels.*.name, 'approved')
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: write
    outputs:
      game_docs: ${{ steps.generate_assessment.outputs.game_docs }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }} 

      - name: Generate AI assessment
        id: generate_assessment
        uses: drewpypro/drewpy-ai-actions/call_assessment_api@gamesv1
        with:
          game_name: ${{ needs.validate.pre_process_validation.outputs.game_name }}
      
      - name: Generate Approval PR
        id: assessment_approval
        env:
          GIT_AUTHOR_NAME: github-actions
          GIT_AUTHOR_EMAIL: github-actions@github.com
          GIT_COMMITTER_NAME: github-actions
          GIT_COMMITTER_EMAIL: github-actions@github.com
        run: |
          echo "Generating PR for Human Review"
          AUTHOR=$(jq -r '.issue.user.login' "$GITHUB_EVENT_PATH")
          ISSUE_ID=${{ github.event.issue.number }}
          BRANCH="issue-${ISSUE_ID}"

          # Check if branch already exists
          if git ls-remote --heads origin | grep -q "refs/heads/$BRANCH"; then
            # Branch exists, create a unique branch name
            BRANCH="issue-${ISSUE_ID}-$(date +%s)"
          fi

          # Create and switch to the branch
          git checkout -b "$BRANCH"

          # Commit only if there are changes
          if ! git diff --staged --quiet; then
            git add "${{ steps.request_validation.outputs.md_path }}"
            git add "${{ steps.request_validation.outputs.json_path }}"
            git commit -m "Add ${GAME_NAME} assessment files generated from ai assessment step from issue #${ISSUE_ID}"
            
            # Force push or push with lease to handle potential conflicts
            git push -f origin "$BRANCH"
          
            PR_URL=$(gh pr create \
              --title "[Auto] Review game assessment request submitted through #${ISSUE_ID}" \
              --body "This PR generates a request for human review of the ${GAME_NAME} assessment generated by ${AUTHOR}." \
              --head "$BRANCH" \
              --base main)

            echo "A PR has been submitted for review, please wait for approval" > /tmp/issue_comment.txt
            gh issue comment $ISSUE_ID --body-file /tmp/issue_comment.txt
            gh label create "under-human-review" --color FBCA04 --description "awaiting human review" || true
            gh issue edit "$ISSUE_ID" --add-label "under-human-review"
  
  # sync_docs_on_merge:
  #   if: github.event_name == 'pull_request' &&
  #       github.event.action == 'closed' &&
  #       github.event.pull_request.merged == true
  #   permissions:
  #     contents: write
  #     steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         ref: ${{ github.head_ref }} 

  #     - name: Generate Docs Update
  #       env:
  #         DOCS_REPO_TOKEN: ${{ secrets.DOCS_REPO_TOKEN }}
  #       run: |
  #         echo "Prepare files for drewpypro.github.io github-pages"
  #         npm, yarn???